<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Air Quality Dashboard</title>
    <style>
      :root { --bg: #f7f7f9; --fg:#0f172a; --card:#ffffff; --muted:#64748b; --accent:#2563eb; --ok:#16a34a; --bad:#b91c1c; --ring: rgba(37, 99, 235, .25); }
      .dark { --bg:#0b1220; --fg:#e5e7eb; --card:#121a2b; --muted:#94a3b8; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; }
      body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--fg); transition: background .2s,color .2s; }
      .hero { background: linear-gradient(135deg, rgba(59,130,246,.12), rgba(99,102,241,.10)); border-bottom: 1px solid rgba(100,116,139,.2); }
      .container { max-width: 1100px; margin: 0 auto; padding: 20px 16px; }
      .header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
      .title { margin: 0; font-size: 34px; letter-spacing: .2px; }
      .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); margin: 16px 0; border: 1px solid rgba(100,116,139,.18); }
      .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 12px; }
      .reading { text-align: center; }
      .reading h4 { margin: 8px 0 4px; font-size: 13px; color: var(--muted); font-weight: 600; }
      .reading .val { font-size: 22px; font-weight: 800; }
      .status { padding: 8px 12px; border-radius: 999px; color: #fff; display: inline-block; box-shadow: 0 0 0 2px var(--ring) inset; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      button { padding: 10px 14px; border: 0; border-radius: 10px; background: var(--accent); color: #fff; cursor: pointer; transition: transform .05s ease, box-shadow .2s ease; box-shadow: 0 6px 16px rgba(37,99,235,.2); }
      button:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(37,99,235,.28); }
      button.secondary { background: transparent; color: var(--fg); border: 1px solid rgba(100,116,139,.4); }
      button:disabled { opacity: .6; cursor: not-allowed; }
      input { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,.35); background: transparent; color: var(--fg); }
      label { font-size: 12px; color: var(--muted); }
      .msg { margin-top: 8px; font-size: 14px; }
      .msg.error { color: var(--bad); }
      .msg.success { color: var(--ok); }
      .timestamp { color: var(--muted); font-size: 12px; margin-left: 8px; }
      /* map removed */
      .subtle { color: var(--muted); font-size: 12px; }
    </style>
  <script src="public/theme-injector.js"></script>
  </head>
  <body>
    <div class="hero">
      <div class="container header">
        <h1 class="title">Air Quality Dashboard</h1>
        <div class="row">
          <div class="row" style="gap:6px">
            <span class="timestamp">User:</span>
            <span id="username" class="status" style="background:transparent;color:var(--fg);box-shadow:none">-</span>
          </div>
          <input id="usernameInput" placeholder="Username" style="min-width:160px" />
          <button id="loginBtn" class="secondary">Login</button>
          <button id="themeBtn" class="secondary">Theme</button>
          <span id="status" class="status" style="background:#9ca3af">Checking...</span>
          <button id="refresh">Refresh</button>
        </div>
      </div>
    </div>
    <div class="container">

      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <h2 style="margin:0">Live Data</h2>
          <span id="lastUpdated" class="timestamp"></span>
        </div>
        <div class="grid" id="liveGrid">
          <div class="reading"><h4>PM10</h4><div class="val" id="pm10">-</div></div>
          <div class="reading"><h4>PM2.5</h4><div class="val" id="pm25">-</div></div>
          <div class="reading"><h4>CO2</h4><div class="val" id="co2">-</div></div>
          <div class="reading"><h4>Humidity</h4><div class="val" id="humidity">-</div></div>
          <div class="reading"><h4>Temperature</h4><div class="val" id="temperature">-</div></div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin-top:0">Manual Data Entry</h2>
        <form id="dataForm" class="grid" style="grid-template-columns: repeat(auto-fit,minmax(160px,1fr));">
          <div>
            <label for="pm10Input">PM10</label>
            <input id="pm10Input" name="pm10" type="number" step="0.1" min="0" required />
          </div>
          <div>
            <label for="pm25Input">PM2.5</label>
            <input id="pm25Input" name="pm25" type="number" step="0.1" min="0" required />
          </div>
          <div>
            <label for="co2Input">CO2</label>
            <input id="co2Input" name="co2" type="number" step="1" min="0" required />
          </div>
          <div>
            <label for="humidityInput">Humidity</label>
            <input id="humidityInput" name="humidity" type="number" step="0.1" min="0" max="100" required />
          </div>
          <div>
            <label for="temperatureInput">Temperature</label>
            <input id="temperatureInput" name="temperature" type="number" step="0.1" min="-50" max="100" />
          </div>
          <div style="display:flex; align-items: end;">
            <button id="submitBtn" type="submit">Submit</button>
          </div>
        </form>
        <div id="formMsg" class="msg"></div>
      </div>

      <!-- Map section removed as requested -->

      <div class="card">
        <div class="row" style="justify-content: space-between; align-items: end;">
          <div>
            <h2 style="margin:0">Weather</h2>
            <div class="subtle">Uses OpenWeatherMap (set key in localStorage as OWM_KEY)</div>
          </div>
          <div class="row">
            <input id="cityInput" placeholder="Enter city (e.g., Delhi)" style="min-width:200px" />
            <button id="checkWeatherBtn" class="secondary">Check Weather</button>
          </div>
        </div>
        <div class="grid" style="margin-top:12px">
          <div class="reading"><h4>City</h4><div class="val" id="weatherCity">-</div></div>
          <div class="reading"><h4>Temperature</h4><div class="val" id="weatherTemp">-</div></div>
          <div class="reading"><h4>Humidity</h4><div class="val" id="weatherHumidity">-</div></div>
          <div class="reading"><h4>Wind</h4><div class="val" id="weatherWind">-</div></div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = (window.localStorage.getItem('API_BASE')) || 'http://localhost:5000';
      const backendStatus = document.getElementById('status');
      const refreshBtn = document.getElementById('refresh');
      const lastUpdated = document.getElementById('lastUpdated');
      const fields = ['pm10','pm25','co2','humidity','temperature'];
      const ids = Object.fromEntries(fields.map(f => [f, document.getElementById(f)]));
      const form = document.getElementById('dataForm');
      const formMsg = document.getElementById('formMsg');
      const submitBtn = document.getElementById('submitBtn');
      const themeBtn = document.getElementById('themeBtn');
      const loginBtn = document.getElementById('loginBtn');
      const usernameInput = document.getElementById('usernameInput');
      const usernameSpan = document.getElementById('username');
      const cityInput = document.getElementById('cityInput');
      const checkWeatherBtn = document.getElementById('checkWeatherBtn');
      const weatherCity = document.getElementById('weatherCity');
      const weatherTemp = document.getElementById('weatherTemp');
      const weatherHumidity = document.getElementById('weatherHumidity');
      const weatherWind = document.getElementById('weatherWind');
      let map, userMarker;

      function setStatus(connected) {
        backendStatus.textContent = connected ? 'Backend: Connected' : 'Backend: Disconnected';
        backendStatus.style.background = connected ? '#16a34a' : '#b91c1c';
      }

      async function fetchReadings() {
        try {
          const res = await fetch(`${API_BASE}/readings`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          setStatus(true);
          if (data && Object.keys(data).length) {
            const r = data;
            ids.pm10.textContent = `${r.pm10 ?? '-'}${r.pm10 != null ? ' µg/m³' : ''}`;
            ids.pm25.textContent = `${r.pm25 ?? '-'}${r.pm25 != null ? ' µg/m³' : ''}`;
            ids.co2.textContent = `${r.co2 ?? '-'}${r.co2 != null ? ' ppm' : ''}`;
            ids.humidity.textContent = `${r.humidity ?? '-'}${r.humidity != null ? ' %' : ''}`;
            ids.temperature.textContent = (r.temperature ?? '-') + (r.temperature != null ? ' °C' : '');
            lastUpdated.textContent = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
            if (r.username) usernameSpan.textContent = r.username;
          } else {
            fields.forEach(f => ids[f].textContent = '-');
            lastUpdated.textContent = '';
          }
        } catch (e) {
          console.error('Fetch readings failed', e);
          setStatus(false);
        }
      }

      async function submitReading(ev) {
        ev.preventDefault();
        formMsg.textContent = '';
        formMsg.className = 'msg';
        submitBtn.disabled = true;
        try {
          const payload = Object.fromEntries(new FormData(form).entries());
          const body = {
            pm10: parseFloat(payload.pm10),
            pm25: parseFloat(payload.pm25),
            co2: parseFloat(payload.co2),
            humidity: parseFloat(payload.humidity),
            temperature: payload.temperature !== '' ? parseFloat(payload.temperature) : null,
            username: usernameSpan.textContent && usernameSpan.textContent !== '-' ? usernameSpan.textContent : null
          };
          const res = await fetch(`${API_BASE}/readings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const data = await res.json();
          console.log('POST /readings response', data);
          if (!res.ok) throw new Error(data.error || 'Failed to submit');
          formMsg.textContent = `Saved at ${data.reading?.timestamp || 'server'}`;
          formMsg.className = 'msg success';
          form.reset();
          await fetchReadings();
        } catch (e) {
          formMsg.textContent = e.message || 'Submission failed';
          formMsg.className = 'msg error';
        } finally {
          submitBtn.disabled = false;
        }
      }

      refreshBtn.addEventListener('click', fetchReadings);
      form.addEventListener('submit', submitReading);

      // initial load + poll every 30s
      fetchReadings();
      setInterval(fetchReadings, 30000);

      // Theme toggle
      themeBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
      });

      // Simple login
      loginBtn.addEventListener('click', () => {
        const u = (usernameInput.value || '').trim();
        if (!u) { alert('Enter a username'); return; }
        usernameSpan.textContent = u;
        localStorage.setItem('AQI_USERNAME', u);
        alert('Signed in as ' + u);
      });

      // Map
      function initMap() {
        if (map) return;
        map = L.map('map');
        const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
        tiles.addTo(map);
        const fallback = [28.6139, 77.2090];
        map.setView(fallback, 11);
        userMarker = L.marker(fallback).addTo(map);
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            const ll = [pos.coords.latitude, pos.coords.longitude];
            map.setView(ll, 13);
            userMarker.setLatLng(ll);
          });
        }
      }

      const savedUser = localStorage.getItem('AQI_USERNAME');
      if (savedUser) { usernameSpan.textContent = savedUser; usernameInput.value = savedUser; }

      window.addEventListener('load', () => { if (window.L) initMap(); });

      // Weather
      async function fetchWeather(city) {
        if (!city) return;
        const key = localStorage.getItem('OWM_KEY');
        if (!key) {
          weatherCity.textContent = 'Set OWM_KEY in localStorage';
          return;
        }
        try {
          const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${key}&units=metric`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Weather HTTP ' + res.status);
          const w = await res.json();
          weatherCity.textContent = w.name;
          weatherTemp.textContent = `${Math.round(w.main.temp)} °C`;
          weatherHumidity.textContent = `${w.main.humidity} %`;
          weatherWind.textContent = `${w.wind.speed} m/s`;
          localStorage.setItem('AQI_LAST_CITY', w.name);
        } catch (err) {
          console.error(err);
          weatherCity.textContent = 'Error';
          weatherTemp.textContent = weatherHumidity.textContent = weatherWind.textContent = '-';
        }
      }

      checkWeatherBtn.addEventListener('click', () => {
        const city = (cityInput.value || '').trim();
        fetchWeather(city);
      });

      const lastCity = localStorage.getItem('AQI_LAST_CITY');
      if (lastCity) {
        cityInput.value = lastCity;
        fetchWeather(lastCity);
      }

      // Ensure Refresh also re-fetches weather
      refreshBtn.addEventListener('click', () => {
        const city = (cityInput.value || '').trim();
        if (city) fetchWeather(city);
      });
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  </body>
</html>
